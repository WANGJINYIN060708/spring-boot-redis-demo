(function($){$.util.namespace("$.fn.tabs.extensions");$.extend($.fn.tabs.extensions,{add:$.fn.tabs.methods.add,update:$.fn.tabs.methods.update});function getTabOption(target,which){var t=$(target),tab=t.tabs("getTab",which),tabOpts=tab.panel("options");return tabOpts}function getSelectedOption(target){var t=$(target),tab=t.tabs("getSelected"),tabOpts=tab.panel("options");return tabOpts}function getSelectedIndex(target){var t=$(target),tab=t.tabs("getSelected"),index=t.tabs("getTabIndex",tab);return index}function getSelectedTitle(target){var t=$(target),tabOpts=t.tabs("getSelectedOption"),title=tabOpts.title;return title}function getHeader(target){var t=$(target);var panel=t.panel("panel"),index=panel.index(),tabs=panel.closest(".tabs-container");return tabs.find(">div.tabs-header>div.tabs-wrap>ul.tabs>li").eq(index)}function loading(target){var t=$(target),state=$.data(target,"tabs"),opts=state.options;if(opts.loading=="mask"){$.easyui.loading({topMost:false,locale:target,msg:opts.loadMsg})}else if(opts.loading=="progress"){$.messager.progress({title:"操作提醒",msg:opts.loadMsg,interval:100})}}function loaded(target){var t=$(target),state=$.data(target,"tabs"),opts=state.options;if(opts.loading=="mask"){$.easyui.loaded({topMost:false,locale:target})}else if(opts.loading=="progress"){$.messager.progress("close")}}function updateTabLoading(t,opts,index,popts){if(popts.href&&(opts.loading=="mask"||opts.loading=="progress")&&(popts.selected||index==-1||t.tabs("getTabIndex",t.tabs("getSelected"))==index)){var target=t[0],onBeforeLoad=popts.onBeforeLoad,onLoad=popts.onLoad,onLoadError=popts.onLoadError;popts.onBeforeLoad=function(){var ret=$.isFunction(onBeforeLoad)?onBeforeLoad.apply(this,arguments):undefined;loading(target);if(ret==false){loaded(target)}return ret};popts.onLoad=function(){var ret=$.isFunction(onLoad)?onLoad.apply(this,arguments):undefined;$.util.delay(function(){loaded(target)});popts.onLoad=onLoad;return ret};popts.onLoadError=function(){var ret=$.isFunction(onLoadError)?onLoadError.apply(this,arguments):undefined;$.util.delay(function(){loaded(target)});popts.onLoadError=onLoadError;return ret}}}function beginUpdateHeader(t,opts,index,popts){if(popts.refreshable){popts.tools=$.array.likeArrayNotString(popts.tools)?$.array.merge([],popts.tools,$.fn.tabs.extensions.tabMiniButtons):$.array.merge([],$.fn.tabs.extensions.tabMiniButtons)}updateTabLineheight(t,opts)}function updateTabLineheight(t,opts){if(opts.lineheight>0){var pos=opts.tabPosition;if(pos!="top"&&pos!="bottom"&&pos!="left"&&pos!="right"){pos="top"}t.children("div.tabs-panels").css("padding-"+pos,opts.lineheight+"px").children().children().css("border-"+pos+"-width","1px")}}function endUpdateHeader(t,opts,index,poptsbak){var p=t.tabs("getTab",index),popts=p.panel("options");popts.tools=poptsbak.tools;if(popts.closeOnDblClick&&popts.closable){t.find(">div.tabs-header>div.tabs-wrap>ul.tabs>li>.tabs-inner").eq(index).attr("title","双击此选项卡标题可以将其关闭")}}$.fn.tabs.extensions.tabMiniButtons=[{iconCls:"icon-mini-refresh",handler:function(){var li=$(this).closest("li"),index=li.index();$.util.delay(function(){var target=li.closest(".tabs-container")[0];refreshTab(target,index)})}}];$.fn.tabs.extensions.closeCurrentTab=function(target,iniframe){if(!target){return}var isiframe=iniframe&&!$.util.isUtilTop?true:false;if(isiframe&&($.util.currentFrame==null||$.util.currentFrame==undefined)){return}var jq=isiframe?$.util.parent.$:$,current=isiframe?jq($.util.currentFrame):jq(target),t=current.currentTabs();if(t.length){var index=current.currentTabIndex();if(index>-1){t.tabs("close",index)}}};$.fn.tabs.extensions.refreshCurrentTab=function(target,iniframe){if(!target){return}var isiframe=iniframe&&!$.util.isUtilTop?true:false;if(isiframe&&($.util.currentFrame==null||$.util.currentFrame==undefined)){return}var jq=isiframe?$.util.parent.$:$,current=isiframe?jq($.util.currentFrame):jq(target),t=current.currentTabs();if(t.length){var index=current.currentTabIndex();if(index>-1){t.tabs("refresh",index)}}};function refreshTab(target,which){var t=$(target),state=$.data(target,"tabs"),opts=state.options,p=t.tabs("getTab",which),popts=p.panel("options");if($.string.isNullOrWhiteSpace(popts.href)){return}var index=t.tabs("getTabIndex",p);if($.isFunction(opts.onBeforeRefresh)&&opts.onBeforeRefresh.call(target,opts.title,index)==false){return}updateTabLoading(t,opts,index,popts);p.panel("refresh");if($.isFunction(opts.onRefresh)){opts.onRefresh.call(target,opts.title,index)}}function addTab(target,options){var t=$(target),state=$.data(target,"tabs"),opts=state.options,index=$.isNumeric(options.index)?options.index:-1,popts=$.extend({},$.fn.tabs.extensions.tabOptions,options||{}),poptsbak=$.extend({},popts);updateTabLoading(t,opts,index,popts);$.fn.tabs.extensions.add.call(t,t,popts)}function updateTab(target,param){param=$.extend({tab:null,type:"all",options:null},param);if(!param.tab||!param.tab.length){return}var t=$(target),state=$.data(target,"tabs"),opts=state.options,index=t.tabs("getTabIndex",param.tab),popts=$.union(param.options,$.fn.tabs.extensions.tabOptions),poptsbak=$.extend({},popts);if(param.type=="all"){beginUpdateHeader(t,opts,index,popts);updateTabLoading(t,opts,index,popts);$.fn.tabs.extensions.update.call(t,t,{tab:param.tab,type:param.type,options:popts});endUpdateHeader(t,opts,index,poptsbak)}else if(param.type=="header"){beginUpdateHeader(t,opts,index,popts);$.fn.tabs.extensions.update.call(t,t,{tab:param.tab,type:param.type,options:popts});endUpdateHeader(t,opts,index,poptsbak)}else if(param.type=="body"){updateTabLoading(t,opts,index,popts);$.fn.tabs.extensions.update.call(t,t,{tab:param.tab,type:param.type,options:popts})}}function insertTab(target,param){if(!param||param.which==null||param.which==undefined||!param.options){return}if(param.point==null||param.point==undefined){param.point="before"}if(param.point!="before"&&param.point!="after"){return}var t=$(target),type=$.type(param.which),p=type=="number"||type=="string"?t.tabs("getTab",param.which):$(param.which),index=t.tabs("getTabIndex",p);if(index==-1){return}var i=param.point=="before"?index:index+1,popts=$.extend({},param.options,{index:i});t.tabs("add",popts)}function moveTab(target,param){if(param==undefined||param==null||param.source==undefined||param.source==null||param.target==undefined||param.target==null){return}var t=$(target),sourceType=$.type(param.source),sourceTab=sourceType=="number"||sourceType=="string"?t.tabs("getTab",param.source):$(param.source),sourceIndex=t.tabs("getTabIndex",sourceTab);if(sourceIndex==-1){return}var targetType=$.type(param.target),targetTab=targetType=="number"||targetType=="string"?t.tabs("getTab",param.target):$(param.target),targetIndex=t.tabs("getTabIndex",targetTab);if(targetIndex==-1||targetIndex==sourceIndex){return}sourceTab=t.tabs("getTab",sourceIndex);targetTab=t.tabs("getTab",targetIndex);var point=param.point=="before"||param.point=="after"?param.point:"before";if(point=="before"&&sourceIndex==targetIndex-1||point=="after"&&sourceIndex==targetIndex+1){return}var state=$.data(target,"tabs"),opts=state.options;if($.isFunction(opts.onBeforeMove)&&opts.onBeforeMove.call(target,targetTab[0],sourceTab[0],point)==false){return}var tabs=t.tabs("tabs"),sourceHeader=getHeader(sourceTab[0]),targetHeader=getHeader(targetTab[0]),sourcePanel=sourceTab.panel("panel"),targetPanel=targetTab.panel("panel");$.array.removeAt(tabs,sourceIndex);var i=targetIndex>sourceIndex?targetIndex-1:targetIndex;$.array.insert(tabs,point=="before"?i:i+1,sourceTab);targetHeader[point](sourceHeader);targetPanel[point](sourcePanel);if($.isFunction(opts.onMove)){opts.onMove.call(target,targetTab[0],sourceTab[0],point)}}function initTabHeaderDblClickEvent(t,opts){t.children("div.tabs-header").delegate(".tabs-inner","dblclick",function(e){var li=$(e.target).closest("li");if(li.length&&!li.is(".tabs-disabled")){var index=li.index(),popts=getTabOption(t[0],index);if(popts.closeOnDblClick&&popts.closable){t.tabs("close",index)}}})}function initializeExtensions(target){var t=$(target),state=$.data(target,"tabs"),opts=state.options;initTabHeaderDblClickEvent(t,opts)}var _tabs=$.fn.tabs.extensions._tabs=$.fn.tabs;$.fn.tabs=function(options,param){if(typeof options=="string"){return _tabs.apply(this,arguments)}options=options||{};return this.each(function(){var jq=$(this),isInited=$.data(this,"tabs")?true:false,opts=isInited?options:$.extend({},$.fn.tabs.parseOptions(this),$.parser.parseOptions(this,["loading","loadMsg",{lineheight:"number"}]),options);_tabs.call(jq,opts,param);if(!isInited){initializeExtensions(this)}})};$.union($.fn.tabs,_tabs);var tabOptions=$.fn.tabs.extensions.tabOptions={iniframe:false,refreshable:true,closeOnDblClick:true,href:null,iconCls:"icon-standard-application-form"};function leftTabs(target,which){var tabs=$(target),index=$.isNumeric(which)?which:tabs.tabs("getTabIndex",tabs.tabs("getTab",which)),panels=tabs.tabs("tabs");return $.array.range(panels,0,index)}function rightTabs(target,which){var tabs=$(target),index=$.isNumeric(which)?which:tabs.tabs("getTabIndex",tabs.tabs("getTab",which)),panels=tabs.tabs("tabs");return $.array.range(panels,index+1)}function otherTabs(target,which){var tabs=$(target),index=$.isNumeric(which)?which:tabs.tabs("getTabIndex",tabs.tabs("getTab",which)),panels=tabs.tabs("tabs");return $.array.merge($.array.range(panels,0,index),$.array.range(panels,index+1))}function closableFinder(p){return p.panel("options").closable}function closableTabs(target){var tabs=$(target),panels=tabs.tabs("tabs");return $.array.filter(panels,closableFinder)}function leftClosableTabs(target,which){var tabs=$(target),panels=tabs.tabs("leftTabs",which);return $.array.filter(panels,closableFinder)}function rightClosableTabs(target,which){var tabs=$(target),panels=tabs.tabs("rightTabs",which);return $.array.filter(panels,closableFinder)}function otherClosableTabs(target,which){var tabs=$(target),panels=tabs.tabs("otherTabs",which);return $.array.filter(panels,closableFinder)}function closeLeftTabs(target,which){var tabs=$(target),panels=tabs.tabs("leftTabs",which);$.each($.array.clone(panels),function(){tabs.tabs("close",tabs.tabs("getTabIndex",this))})}function closeRightTabs(target,which){var tabs=$(target),panels=tabs.tabs("rightTabs",which);$.each($.array.clone(panels),function(){tabs.tabs("close",tabs.tabs("getTabIndex",this))})}function closeOtherTabs(target,which){var tabs=$(target),panels=tabs.tabs("otherTabs",which);$.each($.array.clone(panels),function(){tabs.tabs("close",tabs.tabs("getTabIndex",this))})}function closeAllTabs(target){var tabs=$(target),panels=tabs.tabs("tabs");$.each($.array.clone(panels),function(){tabs.tabs("close",tabs.tabs("getTabIndex",this))})}function closeClosableTab(target,which){var tabs=$(target),panel=tabs.tabs("getTab",which);if(panel&&panel.panel("options").closable){var index=$.isNumeric(which)?which:tabs.tabs("getTabIndex",panel);tabs.tabs("close",index)}}function closeLeftClosableTabs(target,which){var tabs=$(target),panels=tabs.tabs("leftClosableTabs",which);$.each($.array.clone(panels),function(){tabs.tabs("close",tabs.tabs("getTabIndex",this))})}function closeRightClosableTabs(target,which){var tabs=$(target),panels=tabs.tabs("rightClosableTabs",which);$.each($.array.clone(panels),function(){tabs.tabs("close",tabs.tabs("getTabIndex",this))})}function closeOtherClosableTabs(target,which){var tabs=$(target),panels=tabs.tabs("otherClosableTabs",which);$.each($.array.clone(panels),function(){tabs.tabs("close",tabs.tabs("getTabIndex",this))})}function closeAllClosableTabs(target,which){var tabs=$(target),panels=tabs.tabs("closableTabs",which);$.each($.array.clone(panels),function(){tabs.tabs("close",tabs.tabs("getTabIndex",this))})}var defaults=$.fn.tabs.extensions.defaults={lineheight:2,loading:"mask",loadMsg:"正在加载数据，请稍等...",onBeforeRefresh:function(title,index){},onRefresh:function(title,index){},onBeforeMove:function(target,source,point){},onMove:function(target,source,point){}};var methods=$.fn.tabs.extensions.methods={add:function(jq,options){return jq.each(function(){addTab(this,options)})},update:function(jq,param){return jq.each(function(){updateTab(this,param)})},insert:function(jq,param){return jq.each(function(){insertTab(this,param)})},move:function(jq,param){return jq.each(function(){moveTab(this,param)})},refresh:function(jq,which){return jq.each(function(){refreshTab(this,which)})},loading:function(jq){return jq.each(function(){loading(this)})},loaded:function(jq){return jq.each(function(){loaded(this)})},getSelectedOption:function(jq){return getSelectedOption(jq[0])},getSelectedIndex:function(jq){return getSelectedIndex(jq[0])},getSelectedTitle:function(jq){return getSelectedTitle(jq[0])},leftTabs:function(jq,which){return leftTabs(jq[0],which)},rightTabs:function(jq,which){return rightTabs(jq[0],which)},otherTabs:function(jq,which){return otherTabs(jq[0],which)},closableTabs:function(jq){return closableTabs(jq[0])},leftClosableTabs:function(jq,which){return leftClosableTabs(jq[0],which)},rightClosableTabs:function(jq,which){return rightClosableTabs(jq[0],which)},otherClosableTabs:function(jq,which){return otherClosableTabs(jq[0],which)},closeLeft:function(jq,which){return jq.each(function(){closeLeftTabs(this,which)})},closeRight:function(jq,which){return jq.each(function(){closeRightTabs(this,which)})},closeOther:function(jq,which){return jq.each(function(){closeOtherTabs(this,which)})},closeAll:function(jq){return jq.each(function(){closeAllTabs(this)})},closeClosable:function(jq,which){return jq.each(function(){closeClosableTab(this,which)})},closeLeftClosable:function(jq,which){return jq.each(function(){closeLeftClosableTabs(this,which)})},closeRightClosable:function(jq,which){return jq.each(function(){closeRightClosableTabs(this,which)})},closeOtherClosable:function(jq,which){return jq.each(function(){closeOtherClosableTabs(this,which)})},closeAllClosable:function(jq){return jq.each(function(){closeAllClosableTabs(this)})}};$.extend($.fn.panel.defaults,$.fn.tabs.extensions.tabOptions);$.extend($.fn.tabs.defaults,defaults);$.extend($.fn.tabs.methods,methods);$.fn.extend({closeCurrentTab:function(iniframe){return this.each(function(){$.fn.tabs.extensions.closeCurrentTab(this,iniframe)})},refreshCurrentTab:function(iniframe){return this.each(function(){$.fn.tabs.extensions.refreshCurrentTab(this,iniframe)})}})})(jQuery);
