(function($,undefined){function create(target){var t=$(target).addClass("euploadify-f").hide(),state=$.data(target,"euploadify"),opts=state.options,name=state.name=t.attr("name");state.uploadifyID="euploadify_"+$.util.guid("N");state.queueID="euploadify_queue_"+$.util.guid("N");state.lastFileID=null;state.panel=$('<div class="euploadify-panel"></div>').insertAfter(t).append(t).panel($.extend({},opts,{onResize:function(width,height){$.fn.panel.defaults.onResize.apply(this,arguments);$.extend(opts,{width:width,height:height});setSize(target);if($.isFunction(opts.onResize)){opts.onResize.apply(target,arguments)}}}));state.wrapper=state.panel.panel("body").addClass("euploadify-wrapper");state.queueDOM=$("<div id='"+state.queueID+"' class='euploadify-queue'></div>").appendTo(state.wrapper);state.queues=[];t.removeAttr(name).attr("euploadifyName",name);opts.originalValue=opts.value;opts.originalFormData=$.extend({},opts.formData);initializeUploadify(target);setValues(target,opts.value);setSize(target);setValidation(target)}function initializeUploadify(target){var state=$.data(target,"euploadify"),opts=state.options;var uopts={auto:opts.auto,buttonClass:opts.buttonClass,buttonText:opts.buttonText,fileObjName:opts.fileObjName,fileSizeLimit:opts.fileSizeLimit,fileType:opts.fileType,formData:opts.formData,itemTemplate:opts.itemTemplate,method:opts.method,multi:opts.multi,overrideEvents:opts.overrideEvents,queueID:state.queueID,queueSizeLimit:opts.queueSizeLimit,removeCompleted:opts.removeCompleted,simUploadLimit:opts.simUploadLimit,truncateLength:opts.truncateLength,uploadLimit:opts.uploadLimit,uploader:opts.uploader,width:opts.buttonWidth,height:opts.buttonHeight,onAddQueueItem:function(file){},onFallback:function(){return opts.onFallback.apply(target,arguments)},onInit:function(){return opts.onInit.apply(target,arguments)},onQueueComplete:function(){return opts.onQueueComplete.apply(target,arguments)},onSelect:function(file){state.queues.push($.extend({},file));return opts.onSelect.apply(target,arguments)},onSelectError:function(){return opts.onSelectError.apply(target,arguments)},onUploadComplete:function(file){return opts.onUploadComplete.apply(target,arguments)},onUploadError:function(file,errorString){return opts.onUploadError.apply(target,arguments)},onUploadProgress:function(file,bytesUploaded,bytesTotal,totalBytesUploaded,totalBytesTotal){return opts.onUploadProgress.apply(target,arguments)},onUploadStart:function(file){return opts.onUploadStart.apply(target,arguments)},onUploadSuccess:function(file,data,response){var val=file.value;var values=[val];setValues(target,values);return opts.onUploadSuccess.apply(target,arguments)}};state.wrapper.addClass("euploadify-wrapper-single");state.queueDOM.addClass("euploadify-hidden");state.progressbar=$('<div class="euploadify-progressbar"></div>').insertBefore(state.queueDOM).progressbar({width:210,height:28,value:0,text:opts.emptyText});state.buttonbar=$('<div class="euploadify-buttonbar"></div>').insertAfter(state.progressbar);var onSelect=uopts.onSelect,onUploadStart=uopts.onUploadStart,onUploadProgress=uopts.onUploadProgress,onUploadError=uopts.onUploadError,onUploadSuccess=uopts.onUploadSuccess;$.extend(uopts,{onAddQueueItem:function(file){var ret=onSelect.apply(this,arguments);if(state.lastFileID){state.uploadify.uploadify("cancel",state.lastFileID)}if(file){state.progressbar.progressbar("setText",getFileName(target,file)+"("+$.number.toFileSize(file.size)+") - 0%").progressbar("setValue",0).find(".progressbar-value .progressbar-text").removeClass("progressbar-text-success progressbar-text-error");state.lastFileID=file.id}else{state.progressbar.progressbar("setText",opts.emptyText).progressbar("setValue",0).find(".progressbar-value .progressbar-text").removeClass("progressbar-text-success progressbar-text-error")}return ret},onUploadStart:function(file){var ret=onUploadStart.apply(this,arguments);state.progressbar.progressbar("setText",getFileName(target,file)+"("+$.number.toFileSize(file.size)+") - 0%").progressbar("setValue",0).find(".progressbar-value .progressbar-text").removeClass("progressbar-text-success progressbar-text-error");return ret},onUploadProgress:function(file,e){var ret=onUploadProgress.apply(this,arguments),val=Math.round(e.loaded/e.total*100);state.progressbar.progressbar("setText",getFileName(target,file)+"("+$.number.toFileSize(file.size)+") - {value}%").progressbar("setValue",val).find(".progressbar-value .progressbar-text").removeClass("progressbar-text-success progressbar-text-error");return ret},onUploadError:function(file,errorString){$.easyui.messager.alert("提示",errorString,"info")},onUploadSuccess:function(file,data){var ret=onUploadSuccess.apply(this,arguments);state.progressbar.progressbar("setText",getFileName(target,file)+"("+opts.finishText+")").find(".progressbar-value .progressbar-text").removeClass("progressbar-text-success progressbar-text-error").addClass("progressbar-text-success");return ret}});state.button=$('<a class="l-btn l-btn-small'+(opts.buttonPlain?" l-btn-plain":"")+'"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-icon '+opts.buttonIcon+'">&nbsp;</span></span></a>').appendTo(state.buttonbar);state.uploadify=$('<input id="'+state.uploadifyID+'" type="file" />').insertBefore(state.button.find("span.l-btn-icon")).uploadify(uopts);state.uploadify=$("#"+state.uploadifyID);if(opts.tooltip){var tooltip=opts.tooltip===true?$.fn.euploadify.defaults.tooltip:opts.tooltip;if(state.button){state.button.tooltip({content:tooltip.button})}}}function getOptions(target){var state=$.data(target,"euploadify");return $.extend(state.options,{})}function getUploadify(target){return $.data(target,"euploadify").uploadify}function getFileName(target,file){if(!file||!file.name){return $(target).euploadify("options").emptyText}return $.string.getByteLen(file.name)>28?$.string.leftBytes(file.name,25)+"...":file.name}function getQueueDOM(target){return $.data(target,"euploadify").queueDOM}function getQueues(target){return $.array.clone($.data(target,"euploadify").queues)}function setSize(target){var state=$.data(target,"euploadify"),opts=state.options;if(state.buttonbar&&state.progressbar){var width=opts.width-state.buttonbar.outerWidth()-20;state.progressbar.progressbar("resize",width)}}function cancel(target,param){var state=$.data(target,"euploadify");state.uploadify.uploadify("cancel",param)}function destroy(target){var t=$(target),state=$.data(target,"euploadify");state.uploadify.uploadify("destroy");state.panel.panel("destroy");t.remove()}function upload(target,param){$.data(target,"euploadify").uploadify.uploadify("upload",param)}function resize(target,param){var state=$.data(target,"euploadify");state.panel.panel("resize",param)}function hideTip(target){var state=$.data(target,"euploadify");state.tip=false;state.wrapper.tooltip("hide")}function showTip(target){var state=$.data(target,"euploadify"),opts=state.options;state.wrapper.tooltip($.extend({},opts.tipOptions,{content:opts.missingMessage,position:opts.tipPosition,deltaX:opts.deltaX})).tooltip("show");state.tip=true}function repositionTip(target){var state=$.data(target,"euploadify");if(state&&state.tip){state.wrapper.tooltip("reposition")}}function initializeValidate(target){var t=$(target),state=$.data(target,"euploadify"),opts=state.options;state.wrapper.unbind(".euploadify");if(opts.novalidate){return}state.wrapper.bind("focus.euploadify",function(){state.validating=true;state.values=undefined;(function(){if(state.validating){var values=t.euploadify("getValues").join(opts.separator);if(state.values!=values){state.values=values;if(state.timer){clearTimeout(state.timer)}state.timer=setTimeout(function(){t.euploadify("validate")},opts.delay)}else{repositionTip(target)}setTimeout(arguments.callee,200)}})()}).bind("blur.euploadify",function(){if(state.timer){clearTimeout(state.timer);state.timer=undefined}state.validating=false;hideTip(target)}).bind("mouseenter.euploadify",function(){if(state.wrapper.hasClass("euploadify-invalid")){showTip(target)}}).bind("mouseleave.euploadify",function(){if(!state.validating){hideTip(target)}})}function validate(target){var t=$(target),state=$.data(target,"euploadify"),opts=state.options,values=t.euploadify("getValues"),str=values.join(opts.separator);state.wrapper.removeClass("euploadify-invalid");hideTip(target);if(!opts.novalidate&&opts.required&&(!values.length||!str)&&!state.wrapper.hasClass("euploadify-disabled")){state.wrapper.addClass("euploadify-invalid");if(state.validating){showTip(target)}return false}return true}function setValidation(target,novalidate){var state=$.data(target,"euploadify"),opts=state.options;if(novalidate!=undefined&&novalidate!=null){opts.novalidate=novalidate}if(opts.novalidate){state.wrapper.removeClass("euploadify-invalid");hideTip(target)}initializeValidate(target)}function getValues(target){var state=$.data(target,"euploadify");var opts=state.options;return opts.values}function getValue(target){var values=getValues(target);return values[0]}function setValues(target,values){var state=$.data(target,"euploadify"),opts=state.options;var oldValues=$.util.likeArrayNotString(opts.values)?opts.values:[opts.values];var newValues=$.util.likeArrayNotString(values)?values:[values];var strOldValues=oldValues.join(opts.separator);var strNewValues=newValues.join(opts.separator);$(target).val(strNewValues);if(strOldValues!=strNewValues){opts.onChange.call(target,newValues[0],oldValues[0])}opts.values=newValues}function setValue(target,value){setValues(target,[value])}function reset(target){var state=$.data(target,"euploadify"),opts=state.options;setValues(target,opts.originalValue)}function show(target){var state=$.data(target,"euploadify");state.panel.panel("open");return getOptions(target)}function hide(target){var state=$.data(target,"euploadify");state.panel.panel("close");return getOptions(target)}$.fn.euploadify=function(options,param){if(typeof options=="string"){var method=$.fn.euploadify.methods[options];if(method){return method(this,param)}else{return this.euploadify("panel").panel(options,param)}}options=options||{};return this.each(function(){var state=$.data(this,"euploadify");if(state){$.extend(state.options,options)}else{$.data(this,"euploadify",{options:$.extend({},$.fn.euploadify.defaults,$.fn.euploadify.parseOptions(this),options)});create(this)}})};$.fn.euploadify.parseOptions=function(target){return $.extend({},$.parser.parseOptions(target,["buttonClass","buttonText","fileObjName","method","queueID","uploader","emptyText","finishText","errorText","buttonIcon","value","width","height","missingMessage","tipPosition","separator",{auto:"boolean",removeCompleted:"boolean",buttonPlain:"boolean",required:"boolean",novalidate:"boolean"},{fileSizeLimit:"number",height:"number",queueSizeLimit:"number",uploadLimit:"number",width:"number",buttonWidth:"number",buttonHeight:"number",deltaX:"number"}]))};$.fn.euploadify.methods={options:function(jq){return getOptions(jq[0])},panel:function(jq){return $.data(jq[0],"euploadify").panel},uploadify:function(jq){return getUploadify(jq[0])},queueDOM:function(jq){return getQueueDOM(jq[0])},cancel:function(jq,param){return jq.each(function(){cancel(this,param)})},destroy:function(jq){return jq.each(function(){destroy(this)})},disable:function(jq,setDisabled){return jq.each(function(){disable(this,setDisabled)})},stop:function(jq){return jq.each(function(){stop(this)})},queues:function(jq){return getQueues(jq[0])},upload:function(jq,param){return jq.each(function(){upload(this,param)})},resize:function(jq,param){return jq.each(function(){resize(this,param)})},enable:function(jq){return jq.each(function(){enable(this)})},validate:function(jq){return jq.each(function(){validate(this)})},isValid:function(jq){return validate(jq[0])},enableValidation:function(jq){return jq.each(function(){setValidation(this,false)})},disableValidation:function(jq){return jq.each(function(){setValidation(this,true)})},reset:function(jq){return jq.each(function(){reset(this)})},getValues:function(jq){return getValues(jq[0])},setValues:function(jq,values){return jq.each(function(){setValues(this,values)})},getValue:function(jq){return getValue(jq[0])},setValue:function(jq,value){return jq.each(function(){setValue(this,value)})},show:function(jq){return jq.each(function(){show(this)})},hide:function(jq){return jq.each(function(){hide(this)})}};$.fn.euploadify.defaults={auto:true,buttonClass:false,buttonText:"选择...",fileObjName:"Filedata",fileSizeLimit:0,fileType:false,formData:{},itemTemplate:false,method:"post",multi:false,overrideEvents:[],queueID:false,queueSizeLimit:999,removeCompleted:true,simUploadLimit:0,truncateLength:0,uploadLimit:999,uploader:"upload.htm",buttonWidth:80,buttonHeight:26,onInit:function(instance){},onFallback:function(){},onQueueComplete:function(queueData){},onSelect:function(file){},onSelectError:function(file,errorCode,errorMsg){},onUploadComplete:function(file){},onUploadError:function(file,errorCode,errorMsg,errorString){},onUploadProgress:function(file,bytesUploaded,bytesTotal,totalBytesUploaded,totalBytesTotal){},onUploadStart:function(file){},onUploadSuccess:function(file,data,response){}};$.extend($.fn.euploadify.defaults,{emptyText:"未选择文件",finishText:"上传完成!",errorText:"上传失败",tooltip:{button:"打开文件浏览器窗口并选择需要上传的文件"},buttonIcon:"icon-search",value:null,buttonPlain:false,width:"auto",height:"auto",fileType:false,required:false,missingMessage:"附件(文件/档)不能为空,请上传.",tipPosition:"right",deltaX:0,tipOptions:$.fn.validatebox.defaults.tipOptions,separator:",",novalidate:false,onChange:function(newValue,oldValue){}});$.parser.plugins.push("euploadify");if($.fn.form&&$.isArray($.fn.form.otherList)){$.fn.form.otherList.push("euploadify")}})(jQuery);
